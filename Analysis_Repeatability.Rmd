---
title: "Anxiety_F1"
author: "Hamza"
date: "14/04/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#checks for installation and loads packages
pacman::p_load(lmerTest,ggThemeAssist,rptR,lme4,readxl, tidyr, dplyr, magrittr, lubridate, stringr, purrr,
               sjPlot,ggplot2,lubridate,wesanderson,ggbeeswarm,emmeans,patchwork,viridis,nlme,Rmisc,ggpubr,
               stargazer)

```


### Import Data
```{r, include=FALSE}
#Master file with all raw data
Anxiety_Joined <- read.csv("./Data/F1_Anxiety_Repeatability_Exp.csv") 

#Subseting data by tank; NOTE: initially, short tanks are referred to as "Old" tanks, howevever we later change this to refer to them as "Short" tanks
Old_Tanks <- subset(Anxiety_Joined, Anxiety_Joined$Tank == "Old") 
Tall_Tanks <- subset(Anxiety_Joined, Anxiety_Joined$Tank == "Tall") 


#Inspecting imported data 
str(Anxiety_Joined)
str(Old_Tanks)
str(Tall_Tanks)
```

### MAIN ANALYSIS FOR ALL BEHAVIORAL PARAMETERS
1) cHECKING NORMALITY ASSUMPTIONS WITH MIXED MODELS AND A HISTOGRAM OF RESIDUALS
2) PERFORMING REPEATABILITY ANALYSIS FOR EACH TANK SEPARATELY (USING SUBSETS) AND THEN WITH BOTH DATA COMBINED
3) CALCULATING DIFFERENCES BETWEEN REPEATABILITIES
4) FINAL MIXED MODEL USING LME FUNCTION
5) CALCULATING VARIANCE DIFFERENCES BETWEEN TALL AND SHORT TANKS

THESE STEPS ARE REPEATED FOR ALL BEHAVIORAL PARAMETERS, REFER TO THE FIRST BEHAVIORAL PARAMETER FOR COMMENTS AND REFERENCE 

# Total distance travelled
```{r, echo=FALSE}

#Check Normality with mixed model and then histogram of residuals

Model_Tot_Dist <- lmer(tot_dist ~ Tank + Sex + (1 | Fish_ID), data = Anxiety_Joined) #mixed model 
hist(residuals(Model_Tot_Dist)) #histogam of residuals to check for normal distribution (easiest way to check assumption of normality)



#Writing a function for calculating repeatability for total distance travelled
rpt_tot_dist <- function(df) {
  x <- rpt(tot_dist ~ (1 |  Fish_ID), grname = "Fish_ID", data = df, datatype = "Gaussian", nboot = 10000, npermut = 10000)
}

#Calculating repeatabilities using custom made functions
rpt_tot_dist(Old_Tanks) -> Old_Tot_Dist #repeatability for short tanks
rpt_tot_dist(Tall_Tanks) -> Tall_Tot_Dist #repeatability for tall tanks
rpt_tot_dist(Anxiety_Joined) -> Joined_Tot_Dist #repeatability overall (both tanks)

# Writing functions for getting the difference between these two tank's repeatablities
unlist_rptr <- function(rpt_model) { #unlisting the bootstrapped distribution 
  unlist(rpt_model$R_boot)
}

difference_boot <- function(boot1,boot2) { #calculating difference between tall and short (depending on which has the higher repeatability)
  boot1 - boot2
}

quantiles_diff_boot <- function(from_diff_boot) { #obtaining quantiles at 2.5% and 97.5% (becomes 95% CI)
  quantile(from_diff_boot, c(0.025, 0.975))
} 
#Obtaining differences between repeatabilities using custom made functions
Old_tot_dist_boot <- unlist_rptr(Old_Tot_Dist) #unlisting from the short tanks
Tall_tot_dist_boot <- unlist_rptr(Tall_Tot_Dist) #unlisting from the tall tanks
Tot_dist_diff <- difference_boot(Tall_tot_dist_boot,Old_tot_dist_boot) #calculating the difference
q1 <- quantiles_diff_boot(Tot_dist_diff) #obtaining 95% CI
m1 <- mean(Tot_dist_diff) #Obtaining mean

q1
m1

# Calculating difference in variance between short tanks and tall tanks 
Model_Tot_Dist1 <- lme(tot_dist ~ Tank-1 + Sex, random = ~ 1| Fish_ID, data = Anxiety_Joined) #mixed model without variance structure
summary(Model_Tot_Dist1)
Model_Tot_Dist2 <- lme(tot_dist ~ Tank-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Tank), data = Anxiety_Joined) #mixed model with variance structure varIdent
summary(Model_Tot_Dist2)
anova(Model_Tot_Dist1, Model_Tot_Dist2) #calculating difference between two models to find difference in variance
```




### Time spent in low zone ('low duration')
```{r, echo=FALSE}
#Checking normality assumptions
Model_Low_Dur <- lmer(low_dur ~ Tank + Sex + (1 | Fish_ID), data = Anxiety_Joined)  
hist(residuals(Model_Low_Dur)) 
qqnorm(residuals(Model_Low_Dur)) 
scatter.smooth(residuals(Model_Low_Dur)~fitted(Model_Low_Dur)) 

#Writing a function for calculating repeatability for time spent in low zone
rpt_low_dur <- function(df) {
  x <- rpt(low_dur ~ (1 |  Fish_ID), grname = "Fish_ID", data = df, datatype = "Gaussian", nboot = 10000, npermut = 10000)
}


#Calculating repeatabilities 
rpt_low_dur(Old_Tanks) -> Old_low_dur 
rpt_low_dur(Tall_Tanks) -> Tall_low_dur 
rpt_low_dur(Anxiety_Joined) -> Joined_low_dur 

#Obtaining differences between repeatabilities 
Old_low_dur_boot <- unlist_rptr(Old_low_dur) 
Tall_low_dur_boot <- unlist_rptr(Tall_low_dur) 
low_dur_diff <- difference_boot(Tall_low_dur_boot,Old_low_dur_boot) 
q2 <- quantiles_diff_boot(low_dur_diff) 
m2 <- mean(low_dur_diff) 

# Calculating difference in variance between short tanks and tall tanks 
Model_low_dur1 <- lme(low_dur ~ Tank-1 + Sex, random = ~ 1| Fish_ID, data = Anxiety_Joined)
summary(Model_low_dur1)
Model_low_dur2 <- lme(low_dur ~ Tank-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Tank), data = Anxiety_Joined)
summary(Model_low_dur2)
anova(Model_low_dur1, Model_low_dur2)

```



### Time spent in the mid zone ('mid duration')
```{r, echo=FALSE}

#Checking normality assumptions
Model_Mid_Dur <- lmer(mid_dur ~ Tank + Sex + (1 | Fish_ID), data = Anxiety_Joined)  
hist(residuals(Model_Mid_Dur)) 


#Writing a function for calculating repeatability for time spent in mid zone
rpt_mid_dur <- function(df) {
  x <- rpt(mid_dur ~ (1 |  Fish_ID), grname = "Fish_ID", data = df, datatype = "Gaussian", nboot = 10000, npermut = 10000)
}

#Calculating repeatabilities 
rpt_mid_dur(Old_Tanks) -> Old_mid_dur 
rpt_mid_dur(Tall_Tanks) -> Tall_mid_dur 
rpt_mid_dur(Anxiety_Joined) -> Joined_mid_dur 

#Obtaining differences between repeatabilities 
Old_mid_dur_boot <- unlist_rptr(Old_mid_dur) 
Tall_mid_dur_boot <- unlist_rptr(Tall_mid_dur) 
Diff_boot_mid_dur <- difference_boot(Old_mid_dur_boot,Tall_mid_dur_boot) 
q3 <- quantiles_diff_boot(Diff_boot_mid_dur) 
m3 <- mean(Diff_boot_mid_dur) 


# Calculating difference in variance between short tanks and tall tanks 
Model_mid_dur1 <- lme(mid_dur ~ Tank-1 + Sex, random = ~ 1| Fish_ID, data = Anxiety_Joined)
summary(Model_mid_dur1)
Model_mid_dur2 <- lme(mid_dur ~ Tank-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Tank), data = Anxiety_Joined)
summary(Model_mid_dur2)
anova(Model_mid_dur1, Model_mid_dur2)
```




###Time spent in the high zone ('high duration')
```{r, echo=FALSE}

Model_high_dur <- lmer(high_dur ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
hist(residuals(Model_high_dur)) #Our normality assumption is not met, distribution skewed

Model_high_dur2 <- lmer(sqrt(high_dur) ~ Tank + Sex + (1 | Fish_ID), data = Anxiety_Joined)#attempting a square root transformation
hist(residuals(Model_high_dur2))#square root transformation is considered sufficient to meet normal distribution assumption, will be used for this parameter


#Writing a function for calculating repeatability for time spent in high zone
rpt_high_dur <- function(df) {
  x <- rpt(sqrt(high_dur) ~ (1 |  Fish_ID), grname = "Fish_ID", data = df, datatype = "Gaussian", nboot = 10000, npermut = 10000)
}


#Calculating repeatabilities 
rpt_high_dur(Old_Tanks) -> Old_high_dur2 
rpt_high_dur(Tall_Tanks) -> Tall_high_dur2 
rpt_high_dur(Anxiety_Joined) -> Joined_high_dur2 

#Obtaining differences between repeatabilities 
Old_high_dur_boot <- unlist_rptr(Old_high_dur2) 
Tall_high_dur_boot <- unlist_rptr(Tall_high_dur2) 
Diff_boot_high_dur <- difference_boot(Tall_high_dur_boot,Old_high_dur_boot) 
q4 <- quantiles_diff_boot(Diff_boot_high_dur) 
m4 <- mean(Diff_boot_high_dur) 


# Calculating difference in variance between short tanks and tall tanks 

Model_high_dur1a <- lme(sqrt(high_dur) ~ Tank-1 + Sex, random = ~ 1| Fish_ID, data = Anxiety_Joined)
summary(Model_high_dur1a)
Model_high_dur2a <- lme(sqrt(high_dur) ~ Tank-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Tank), data = Anxiety_Joined)
summary(Model_high_dur2a)
anova(Model_high_dur1a, Model_high_dur2a)
```



### Time spent freezing
```{r, echo=FALSE}
Model_freezing_dur <- lmer(freezing_dur ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
hist(residuals(Model_freezing_dur))#Our normality assumption is not met

Model_freezing_dur2 <- lmer(sqrt(freezing_dur) ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
hist(residuals(Model_freezing_dur2))#Our normality assumption is still not satisfied

Model_freezing_dur3 <- lmer(log(freezing_dur+1) ~ Tank + Sex + (1 | Fish_ID), data = Anxiety_Joined)
hist(residuals(Model_freezing_dur3))#Our normality assumption is deemed adequate

#Writing a function for calculating repeatability for time spent freezing
rpt_freezing_dur <- function(df) {
  x <- rpt(log(freezing_dur+1) ~ (1 |  Fish_ID), grname = "Fish_ID", data = df, datatype = "Gaussian", nboot = 10000, npermut = 10000)
}

#Calculating repeatabilities 
rpt_freezing_dur(Old_Tanks) -> Old_freezing_dur3 
rpt_freezing_dur(Tall_Tanks) -> Tall_freezing_dur3 
rpt_freezing_dur(Anxiety_Joined) -> Joined_freezing_dur 

#Obtaining differences between repeatabilities 
Old_freezing_dur_boot <- unlist_rptr(Old_freezing_dur3) 
Tall_freezing_dur_boot <- unlist_rptr(Tall_freezing_dur3) 
Diff_boot_freezing_dur <- difference_boot(Tall_freezing_dur_boot,Old_freezing_dur_boot) 
q5 <- quantiles_diff_boot(Diff_boot_freezing_dur) 
m5 <- mean(Diff_boot_freezing_dur) 


#Variance models
Model_freezing_dur1a <- lme(log(freezing_dur+1) ~ Tank-1 + Sex, random = ~ 1| Fish_ID, data = Anxiety_Joined)
summary(Model_freezing_dur1a)
Model_freezing_dur2a <- lme(log(freezing_dur+1) ~ Tank-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Tank), data = Anxiety_Joined)
summary(Model_freezing_dur2a)
anova(Model_freezing_dur1a, Model_freezing_dur2a)
```

#latency to high
```{r}
Model_latency <- lmer(latency_high ~ Tank + Sex + (1 | Fish_ID), data = Anxiety_Joined)
hist(residuals(Model_latency)) 

#Writing a function for calculating repeatability for latency to the high zone
rpt_latency <- function(df) {
  x <- rpt(latency_high ~ (1 |  Fish_ID), grname = "Fish_ID", data = df, datatype = "Gaussian", nboot = 10000, npermut = 10000)
}


#Calculating repeatabilities 
rpt_latency(Old_Tanks) -> Old_latency
rpt_latency(Tall_Tanks) -> Tall_latency
rpt_latency(Anxiety_Joined) -> Joined_latency

#Obtaining differences between repeatabilities 
Old_latency_boot <- unlist_rptr(Old_latency) 
Tall_latency_boot <- unlist_rptr(Tall_latency) 
Diff_boot_latency <- difference_boot(Tall_latency_boot,Old_latency_boot) 
q6 <- quantiles_diff_boot(Diff_boot_latency) 
m6 <- mean(Diff_boot_latency) 

# Variance models
Model_latency_high1a <- lme(latency_high ~ Tank-1 + Sex, random = ~ 1| Fish_ID, data = Anxiety_Joined, na.action=na.omit)
summary(Model_latency_high1a)
Model_latency_high2a <- lme(latency_high ~ Tank-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Tank), data = Anxiety_Joined, na.action=na.omit)
summary(Model_latency_high2a)
anova(Model_latency_high1a, Model_latency_high2a)
```

#entries into high
```{r}
Model_freq_high <- lmer(freq_high ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
hist(residuals(Model_freq_high)) #assumptions of normality not met

Model_freq_high2 <- lmer(sqrt(freq_high) ~ Tank + Sex + (1 | Fish_ID), data = Anxiety_Joined)
hist(residuals(Model_freq_high2))#square root transformation deemed adequate

#Writing a function for calculating repeatability for latency to the high zone
rpt_freq <- function(df) {
  x <- rpt(sqrt(freq_high) ~ (1 |  Fish_ID), grname = "Fish_ID", data = df, datatype = "Gaussian", nboot = 10000, npermut = 10000)
}


#Calculating repeatabilities 
rpt_freq(Old_Tanks) -> Old_freq_high
rpt_freq(Tall_Tanks) -> Tall_freq_high
rpt_freq(Anxiety_Joined) -> Joined_freq_high


#Obtaining differences between repeatabilities 
Old_freq_boot <- unlist_rptr(Old_freq_high) 
Tall_freq_boot <- unlist_rptr(Tall_freq_high) 
Diff_boot_freq <- difference_boot(Old_freq_boot,Tall_freq_boot) 
q7 <- quantiles_diff_boot(Diff_boot_freq) 
m7 <- mean(Diff_boot_freq) 


#Variance models
Model_freq_high1a <- lme(sqrt(freq_high) ~ Tank-1 + Sex, random = ~ 1| Fish_ID, data = Anxiety_Joined)
summary(Model_freq_high1a)
Model_freq_high2a <- lme(sqrt(freq_high) ~ Tank-1 + Sex, random = ~ 1| Fish_ID, weights = varIdent(form=~1|Tank), data = Anxiety_Joined)
summary(Model_freq_high2a)
anova(Model_freq_high1a, Model_freq_high2a)
```






Violin plots (tank differences)
```{r, echo=FALSE}

#Renaming facets

sex_labs <- c("Female", "Male") 
names(sex_labs) <- c("female", "male")

tank_labs <- c("Short", "Tall")
names(tank_labs) <- c("Old", "Tall")


#Plots

Violin_Dist <- ggplot(Anxiety_Joined, aes(x=Tank, y=tot_dist, fill=Tank)) + 
 geom_violin(alpha = 0.1, draw_quantiles = c(0.25, 0.5, 0.75)) + 
  geom_jitter(width = 0.2, height = 0, alpha = 0.2) +
  labs(title="Total distance travelled",y = "Total distance (cm)")+
theme_grey()+
  scale_fill_manual(values=c("#DD8D29", "#E2D200"))+
 theme(legend.position = "none")+
  scale_x_discrete(labels=c("Old" = "Short", "Tall" = "Tall"))+
  theme(axis.title.x=element_blank())
 

Violin_Dist

ggsave(path = "Plots", file = "Total Distance.jpeg", limitsize = FALSE)



Violin_Low <- ggplot(Anxiety_Joined, aes(x=Tank, y=low_dur, fill=Tank)) + 
geom_violin(alpha = 0.1, draw_quantiles = c(0.25, 0.5, 0.75)) + 
  geom_jitter(width = 0.2, height = 0, alpha = 0.2) +
  labs(title="Time spent in low zone",y = "Time spent (seconds)")+
theme_grey()+
scale_fill_manual(values = wes_palette("FantasticFox1", n = 2))+
 theme(legend.position = "none")+
  scale_x_discrete(labels=c("Old" = "Short", "Tall" = "Tall"))+
  theme(axis.title.x=element_blank())

Violin_Low

ggsave(path = "Plots", file = "Low Duration.jpeg", limitsize = FALSE)


Violin_Mid <- ggplot(Anxiety_Joined, aes(x=Tank, y=mid_dur, fill=Tank)) + 
geom_violin(alpha = 0.1, draw_quantiles = c(0.25, 0.5, 0.75)) + 
  geom_jitter(width = 0.2, height = 0, alpha = 0.2) +
  labs(title="Time spent in middle zone",y = "Time spent (seconds)")+
theme_grey()+
scale_fill_manual(values = wes_palette("FantasticFox1", n = 2))+
 theme(legend.position = "none")+
  scale_x_discrete(labels=c("Old" = "Short", "Tall" = "Tall"))+
  theme(axis.title.x=element_blank())


Violin_Mid
ggsave(path = "Plots", file = "Mid_Duration.jpeg", limitsize = FALSE)


Violin_High <- ggplot(Anxiety_Joined, aes(x=Tank, y=high_dur, fill=Tank)) + 
geom_violin(alpha = 0.1, draw_quantiles = c(0.25, 0.5, 0.75)) + 
  geom_jitter(width = 0.2, height = 0, alpha = 0.2) +
  labs(title="Time spent in high zone",y = "Time spent (seconds)")+
theme_grey()+
scale_fill_manual(values = wes_palette("FantasticFox1", n = 2))+
 theme(legend.position = "none")+
  scale_x_discrete(labels=c("Old" = "Short", "Tall" = "Tall"))+
  theme(axis.title.x=element_blank())

Violin_High

ggsave(path = "Plots", file = "High_Duration.jpeg", limitsize = FALSE)



Violin_Freezing <- ggplot(Anxiety_Joined, aes(x=Tank, y=log(freezing_dur+1), fill=Tank)) +
    geom_violin(alpha = 0.1, draw_quantiles = c(0.25, 0.5, 0.75)) + 
  geom_jitter(width = 0.2, height = 0, alpha = 0.2) +
  labs(title="Time spent freezing",y = "Time spent (seconds)")+
theme_grey()+
scale_fill_manual(values = wes_palette("FantasticFox1", n = 2))+
 theme(legend.position = "none")+
  scale_x_discrete(labels=c("Old" = "Short", "Tall" = "Tall"))+
  theme(axis.title.x=element_blank())

Violin_Freezing

ggsave(path = "Plots", file = "Freezing.jpeg", limitsize = FALSE)



Violin_Latency <- ggplot(Anxiety_Joined, aes(x=Tank, y=latency_high, fill=Tank)) + 
geom_violin(alpha = 0.1, draw_quantiles = c(0.25, 0.5, 0.75)) + 
  geom_jitter(width = 0.2, height = 0, alpha = 0.2) +
  labs(title="Latency to high zone",y = "Seconds")+
theme_grey()+
scale_fill_manual(values = wes_palette("FantasticFox1", n = 2))+
 theme(legend.position = "none")+
  scale_x_discrete(labels=c("Old" = "Short", "Tall" = "Tall"))+
  theme(axis.title.x=element_blank())

Violin_Latency

ggsave(path = "Plots", file = "Latency to High.jpeg", limitsize = FALSE)


Violin_entries <- ggplot(Anxiety_Joined, aes(x=Tank, y=freq_high, fill=Tank)) + 
 geom_violin(alpha = 0.1, draw_quantiles = c(0.25, 0.5, 0.75)) + 
  geom_jitter(width = 0.2, height = 0, alpha = 0.2) +
  labs(title="Entries into the high zone",y = "Number of entries")+
theme_grey()+
scale_fill_manual(values = wes_palette("FantasticFox1", n = 2))+
 theme(legend.position = "none")+
  scale_x_discrete(labels=c("Old" = "Short", "Tall" = "Tall"))+
  theme(axis.title.x=element_blank())

Violin_entries

ggsave(path = "Plots", file = "Entries to high.jpeg", limitsize = FALSE)


###Alternate design (use functions for other plots)

Test <-  ggplot(data = Anxiety_Joined,aes(x = Tank, y = freq_high, fill = Tank))+
 scale_fill_manual(values = wes_palette("FantasticFox1", n = 2))+
  geom_violin(alpha=0.4, position = position_dodge(width = .75),size=1,color="black")+
  geom_boxplot(notch = TRUE,  outlier.size = -1, color="black",lwd=1.2, alpha = 0.7)+
  geom_point( shape = 21,size=2, position = position_jitterdodge(), color="black",alpha=1)+
  theme_pubr()+
  ylab(  c("Number of entries"))+
  xlab(  c("Entries into the high zone"))+
  rremove("legend.title")+
  theme(panel.border = element_rect(colour = "black", fill=NA, size=2),axis.ticks = element_line(size=2,color="black"),axis.ticks.length=unit(0.2,"cm"),legend.position = c(0.92, 0.85))+      font("xylab",size=15)+font("xy",size=15)+font("xy.text", size = 15) +font("legend.text",size = 15)+
    scale_x_discrete(labels=c("Old" = "Short", "Tall" = "Tall"))+
  theme(legend.position = "none")

Test
```



Tables using stargazer
```{r}
stargazer(Model_Tot_Dist1, Model_low_dur1, Model_mid_dur1, Model_high_dur1a, Model_freezing_dur1a, Model_latency_high1a, Model_freq_high1a, omit.stat = c("bic","aic","ll"),  covariate.labels = c("Short Tank", "Tall Tank", "Male"), align = TRUE, type= "html",dep.var.labels= c("Total distance travelled", "Time spent in low zone", "Time spent in mid zone", "Time spent in high zone", "Time spent freezing", "Latency to high zone", "Entries to high zone"),dep.var.caption= "Behavioral parameters",style="all", out = "Table.html")

```







