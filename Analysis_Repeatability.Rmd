---
title: "Anxiety_F1"
author: "Hamza"
date: "14/04/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

### Load packages
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)


#install.packages("pacman")
#install.packages("ggThemeAssist")
#install.packages("ggbeeswarm")
#install.packages("rptR")
#install.packages("lme4")
#install.packages("lmerTest")
#install.packages("wesanderson")
library(lmerTest)
library(ggThemeAssist)
library(rptR)
library(lme4)
library(readxl)
library(dplyr)
pacman::p_load(readxl, tidyr, dplyr, magrittr, lubridate, stringr, purrr)
library(sjPlot)
library(ggplot2)
library(lubridate)
library(wesanderson)
library(ggbeeswarm)
library(emmeans)
library(patchwork)
library(easyGgplot2)
#sessionInfo()
```
The aim of this experiment is to compare repatability in typically used holding tanks against our custom made tall tanks. We designed these tanks to exploit the zebrafish's natural tendency to dive in a novel environment. Typical holding tanks aren't very deep, and as such, it's harder to comapare variability between individuals. We designed our tanks to hold the same amount of water, but have a much deeper column. For this experiment, we aren't interested in the F1 classification of the fish groups (we are referring to all of them as WT) or even the differences between groups. We are only interested in the repeatability measurements. 

### Import Data
```{r, include=FALSE}

Old_Tanks <- read.csv("Old_tanks.csv")
Tall_Tanks <- read.csv("Tall_tanks.csv")
Anxiety_Joined <- read.csv("F1_Anxiety_Repeatability_Exp.csv")

#Inspect
str(Old_Tanks)
str(Tall_Tanks)
str(Anxiety_Joined)


```

#total distance (old, tall, joined)
```{r, echo=FALSE}
hist(Old_Tanks$tot_dist)
hist(Tall_Tanks$tot_dist)
hist(Anxiety_Joined$tot_dist)


# hist(sqrt(Old_Tanks$tot_dist))
# hist(sqrt(Tall_Tanks$tot_dist))
# hist(sqrt(Anxiety_Joined$tot_dist))

Old_Tot_Dist <- rpt(tot_dist ~ (1 | Fish_ID), grname = "Fish_ID", data = Old_Tanks, datatype = "Gaussian", 
    nboot = 100000, npermut = 10000)
Old_Tot_Dist
plot(Old_Tot_Dist)

Tall_Tot_Dist <- rpt(tot_dist ~ (1 | Fish_ID), grname = "Fish_ID", data = Tall_Tanks, datatype = "Gaussian", 
    nboot = 100000, npermut = 10000)
Tall_Tot_Dist
tall_tot_dist_plot <- plot(Tall_Tot_Dist)

Joined_Tot_Dist <- rpt(tot_dist ~ Tank + (1 | Fish_ID), grname = "Fish_ID", data = Anxiety_Joined, datatype = "Gaussian", 
    nboot = 1000000, npermut = 100000)
Joined_Tot_Dist

Model_Tot_Dist <- lmer(tot_dist ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
# summary(Model_Tot_Dist)
tab_model(Model_Tot_Dist)
hist(residuals(Model_Tot_Dist))

# Shinichi's addition to show Hamza how to get the difference between these two tank's repeatablities. 
Old_boot<-unlist(Old_Tot_Dist$R_boot)
hist(Old_boot, breaks = 50)
Tall_boot<-unlist(Tall_Tot_Dist$R_boot)
hist(Tall_boot, breaks = 50)

Diff_boot <- Tall_boot - Old_boot
hist(Diff_boot, breaks = 50)

quantile(Diff_boot, c(0.025, 0.975)) # difference ditribuiton 95% CI
mean(Diff_boot)

# Old_Tanks %>% 
#   ggplot(aes(x = Group, y = tot_dist, colour = Group)) +
#   geom_violin(alpha = 0.1, draw_quantiles = c(0.25, 0.5, 0.75)) + 
#   geom_jitter(width = 0.2, height = 0, alpha = 0.2) +
#   theme_minimal()+
#   labs(title = "Total Distance")
# 
# Tall_Tanks %>% 
#   ggplot(aes(x = Group, y = tot_dist, colour = Group)) +
#   geom_violin(alpha = 0.1, draw_quantiles = c(0.25, 0.5, 0.75)) + 
#   geom_jitter(width = 0.2, height = 0, alpha = 0.2) +
#   theme_minimal()+
#   labs(title = "Total Distance")
# 
# Anxiety_Joined %>% 
#   ggplot(aes(x = Group, y = tot_dist, colour = Group)) +
#   geom_violin(alpha = 0.1, draw_quantiles = c(0.25, 0.5, 0.75)) + 
#   geom_jitter(width = 0.2, height = 0, alpha = 0.2) +
#   theme_minimal()+
#   facet_grid(~Tank)
#   labs(title = "Total Distance")
# 
# model1 <- lmer(tot_dist ~ Group  + (1 | Fish_ID), data = Old_Tanks)
# tab_model(model1)
# 
# model2 <- lmer(tot_dist ~ Group + (1 | Fish_ID), data = Tall_Tanks)
# tab_model(model2)
# 
# model3 <- lmer(tot_dist ~ Group + Tank + (1 | Fish_ID), data = Anxiety_Joined)
# tab_model(model3)


```




###low duration
```{r, echo=FALSE}

# par(mfrow=c(2,2))
hist(Old_Tanks$low_dur)
hist(Tall_Tanks$low_dur)
hist(Anxiety_Joined$low_dur)

model <- lmer(low_dur ~ (1 | Fish_ID), data = Old_Tanks)
summary(model)
plot(residuals(model))
hist(residuals(model))

Old_low_dur <- rpt(low_dur ~ (1 | Fish_ID), grname = "Fish_ID", data = Old_Tanks, datatype = "Gaussian", 
    nboot = 100000, npermut = 100000)
Old_low_dur

plot(Old_low_dur)

Tall_low_dur <- rpt(low_dur ~ (1 | Fish_ID), grname = "Fish_ID", data = Tall_Tanks, datatype = "Gaussian", 
    nboot = 100000, npermut = 100000)
Tall_low_dur

Joined_low_dur <- rpt(low_dur ~ Tank + (1 | Fish_ID), grname = "Fish_ID", data = Anxiety_Joined, datatype = "Gaussian", 
    nboot = 100000, npermut = 100000)
Joined_low_dur

Model_low_dur <- lmer(low_dur ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
summary(Model_low_dur)
tab_model(Model_low_dur)
hist(residuals(Model_low_dur))

### Analysis to find differences

Old_low_dur_boot<-unlist(Old_low_dur$R_boot)
hist(Old_low_dur_boot, breaks = 50)
Tall_low_dur_boot<-unlist(Tall_low_dur$R_boot)
hist(Tall_low_dur_boot, breaks = 50)

Diff_boot_low_dur <- Tall_low_dur_boot - Old_low_dur_boot
hist(Diff_boot_low_dur, breaks = 50)

quantile(Diff_boot_low_dur, c(0.025, 0.975)) # difference ditribuiton 95% CI
mean(Diff_boot_low_dur)

#2.5% quartile greater than zero, indicates a significant difference?

```



###mid duration
```{r, echo=FALSE}


hist(Old_Tanks$mid_dur)
hist(Tall_Tanks$mid_dur)
hist(Anxiety_Joined$mid_dur)

#We need to look at residual normality and not raw data

Old_mid_dur <- rpt(mid_dur ~ (1 | Fish_ID), grname = "Fish_ID", data = Old_Tanks, datatype = "Gaussian", 
    nboot = 100000, npermut = 100000)
Old_mid_dur

plot(Old_mid_dur)

Tall_mid_dur <- rpt(mid_dur ~ (1 | Fish_ID), grname = "Fish_ID", data = Tall_Tanks, datatype = "Gaussian", 
    nboot = 100000, npermut = 100000)
Tall_mid_dur


Joined_mid_dur <- rpt(mid_dur ~ Tank + (1 | Fish_ID), grname = "Fish_ID", data = Anxiety_Joined, datatype = "Gaussian", 
    nboot = 100000, npermut = 100000)
Joined_mid_dur

Model_mid_dur <- lmer(mid_dur ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
summary(Model_mid_dur)
hist(residuals(Model_mid_dur))

###Analysis to find differences

Old_mid_dur_boot<-unlist(Old_mid_dur$R_boot)
hist(Old_mid_dur_boot, breaks = 50)
Tall_mid_dur_boot<-unlist(Tall_mid_dur$R_boot)
hist(Tall_mid_dur_boot, breaks = 50)

Diff_boot_mid_dur <- Old_mid_dur_boot - Tall_mid_dur_boot
hist(Diff_boot_mid_dur, breaks = 50)

quantile(Diff_boot_mid_dur, c(0.025, 0.975)) #2.5% crosses 0, not significant?
mean(Diff_boot_mid_dur)
```




###high duration
```{r, echo=FALSE}


hist(Old_Tanks$high_dur)
hist(Tall_Tanks$high_dur)
hist(Anxiety_Joined$high_dur)

model2 <- lmer(high_dur ~ (1 | Fish_ID), data = Old_Tanks)
summary(model2)
plot(residuals(model2))
hist(residuals(model2))

Old_high_dur <- rpt(high_dur ~ (1 | Fish_ID), grname = "Fish_ID", data = Old_Tanks, datatype = "Gaussian", 
    nboot = 100000, npermut = 100000)
Old_high_dur

Old_high_dur2 <- rpt(sqrt(high_dur) ~ (1 | Fish_ID), grname = "Fish_ID", data = Old_Tanks, datatype = "Gaussian", 
    nboot = 100000, npermut = 100000)
Old_high_dur2

Tall_high_dur <- rpt(high_dur ~ (1 | Fish_ID), grname = "Fish_ID", data = Tall_Tanks, datatype = "Gaussian", 
    nboot = 100000, npermut = 100000)
Tall_high_dur

Tall_high_dur2 <- rpt(sqrt(high_dur) ~ (1 | Fish_ID), grname = "Fish_ID", data = Tall_Tanks, datatype = "Gaussian", 
    nboot = 100000, npermut = 10000)
Tall_high_dur2


Joined_high_dur <- rpt(high_dur ~ Tank + (1 | Fish_ID), grname = "Fish_ID", data = Anxiety_Joined, datatype = "Gaussian", 
    nboot = 10000, npermut = 10000)
Joined_high_dur

Model_high_dur <- lmer(high_dur ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
summary(Model_high_dur)
tab_model(Model_high_dur)
hist(residuals(Model_high_dur))

Model_high_dur2 <- lmer(sqrt(high_dur) ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
summary(Model_high_dur2)
tab_model(Model_high_dur2)
hist(residuals(Model_high_dur2))

###Analysis to find differences

Old_high_dur2_boot<-unlist(Old_high_dur2$R_boot)
hist(Old_high_dur2_boot, breaks = 50)
Tall_high_dur2_boot<-unlist(Tall_high_dur2$R_boot)
hist(Tall_high_dur2_boot, breaks = 50)

Diff_boot_high_dur2 <- Tall_high_dur2_boot - Old_high_dur2_boot
hist(Diff_boot_high_dur2, breaks = 50)

quantile(Diff_boot_high_dur2, c(0.025, 0.975)) #2.5% crosses 0, not significant?
mean(Diff_boot_high_dur2)
```



###freeze dur 
```{r, echo=FALSE}


hist(Old_Tanks$freezing_dur)
hist(Tall_Tanks$freezing_dur)
hist(Anxiety_Joined$freezing_dur)

model3 <- lmer(freezing_dur ~ (1 | Fish_ID), data = Old_Tanks)
summary(model3)
plot(residuals(model3))
hist(residuals(model3))

Old_freezing_dur <- rpt(freezing_dur ~ (1 | Fish_ID), grname = "Fish_ID", data = Old_Tanks, datatype = "Gaussian", 
    nboot = 10000, npermut = 10000)
Old_freezing_dur

Old_freezing_dur2 <- rpt(sqrt(freezing_dur) ~ (1 | Fish_ID), grname = "Fish_ID", data = Old_Tanks, datatype = "Gaussian", 
    nboot = 10000, npermut = 10000)
Old_freezing_dur2

Old_freezing_dur3 <- rpt(log(freezing_dur+1) ~ (1 | Fish_ID), grname = "Fish_ID", data = Old_Tanks, datatype = "Gaussian", 
    nboot = 10000, npermut = 10000)
Old_freezing_dur3

plot(Old_freezing_dur)

Tall_freezing_dur <- rpt(freezing_dur ~ (1 | Fish_ID), grname = "Fish_ID", data = Tall_Tanks, datatype = "Gaussian", 
    nboot = 10000, npermut = 10000)
Tall_freezing_dur

Tall_freezing_dur2 <- rpt(sqrt(freezing_dur) ~ (1 | Fish_ID), grname = "Fish_ID", data = Tall_Tanks, datatype = "Gaussian", 
    nboot = 10000, npermut = 10000)
Tall_freezing_dur2

Tall_freezing_dur3 <- rpt(log(freezing_dur+1) ~ (1 | Fish_ID), grname = "Fish_ID", data = Tall_Tanks, datatype = "Gaussian", 
    nboot = 10000, npermut = 10000)
Tall_freezing_dur3

Joined_freezing_dur <- rpt(freezing_dur ~ Tank + (1 | Fish_ID), grname = "Fish_ID", data = Anxiety_Joined, datatype = "Gaussian", 
    nboot = 10000, npermut = 10000)
Joined_freezing_dur

Model_freezing_dur <- lmer(freezing_dur ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
summary(Model_freezing_dur)
hist(residuals(Model_freezing_dur))


Model_freezing_dur2 <- lmer(sqrt(freezing_dur) ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
summary(Model_freezing_dur2)
hist(residuals(Model_freezing_dur2))

Model_freezing_dur3 <- lmer(log(freezing_dur+1) ~ Tank + (1 | Fish_ID), data = Anxiety_Joined)
summary(Model_freezing_dur3)
tab_model(Model_freezing_dur3)
hist(residuals(Model_freezing_dur3))

###Analysis to find differences

Old_freezing_dur3_boot<-unlist(Old_freezing_dur3$R_boot)
hist(Old_freezing_dur3_boot, breaks = 50)
Tall_freezing_dur3_boot<-unlist(Tall_freezing_dur3$R_boot)
hist(Tall_freezing_dur3_boot, breaks = 50)

Diff_boot_freezing_dur3 <- Old_freezing_dur3_boot - Tall_freezing_dur3_boot
hist(Diff_boot_freezing_dur3, breaks = 50)

quantile(Diff_boot_freezing_dur3, c(0.025, 0.975)) #2.5% crosses 0, not significant?
mean(Diff_boot_freezing_dur3)

```



#Plotting Repeatabilities 

Total distance
```{r, echo=FALSE}
Tot_Dist_rptr <- tibble(
  Tank_Type = c("Short", "Tall"),
  r = c(Old_Tot_Dist$R$Fish_ID,Tall_Tot_Dist$R$Fish_ID),
  ci.lb = c(Old_Tot_Dist$CI_emp$`2.5%`,Tall_Tot_Dist$CI_emp$`2.5%`),
  ci.ub = c(Old_Tot_Dist$CI_emp$`97.5%`,Tall_Tot_Dist$CI_emp$`97.5%`))
  
Tot_Dist_rptr

plot_Tot_Dist_rptr <- ggplot(Tot_Dist_rptr, aes(x=Tank_Type, y=r, colour=Tank_Type)) +
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = Tank_Type, y = r), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(y = "r") +
  labs(title = "Repeatability estimates", subtitle = "A. Total distance")+
  coord_flip()+
   theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  ylim(0, 1)
plot_Tot_Dist_rptr
```



Low duration
```{r, echo=FALSE}
low_dur_rptr <- tibble(
  Tank_Type = c("Short", "Tall"),
  r = c(Old_low_dur$R$Fish_ID,Tall_low_dur$R$Fish_ID),
  ci.lb = c(Old_low_dur$CI_emp$`2.5%`,Tall_low_dur$CI_emp$`2.5%`),
  ci.ub = c(Old_low_dur$CI_emp$`97.5%`,Tall_low_dur$CI_emp$`97.5%`))
  
low_dur_rptr

plot_low_dur_rptr <- ggplot(low_dur_rptr, aes(x=Tank_Type, y=r, colour=Tank_Type)) +
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = Tank_Type, y = r), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Tank Type", y = "r") +
  labs(subtitle = "E. time spent in low zone")+
  coord_flip()+
   theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  ylim(0, 1)
plot_low_dur_rptr
```

Middle duration
```{r, echo=FALSE}
mid_dur_rptr <- tibble(
  Tank_Type = c("Short", "Tall"),
  r = c(Old_mid_dur$R$Fish_ID,Tall_mid_dur$R$Fish_ID),
  ci.lb = c(Old_mid_dur$CI_emp$`2.5%`,Tall_mid_dur$CI_emp$`2.5%`),
  ci.ub = c(Old_mid_dur$CI_emp$`97.5%`,Tall_mid_dur$CI_emp$`97.5%`))
  
mid_dur_rptr

plot_mid_dur_rptr <- ggplot(mid_dur_rptr, aes(x=Tank_Type, y=r, colour=Tank_Type)) +
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = Tank_Type, y = r), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Tank Type", y = "r") +
  labs(subtitle = "D .Time spent in middle zone")+
  coord_flip()+
   theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  ylim(0, 1)
plot_mid_dur_rptr
```

High duration
```{r, echo=FALSE}
high_dur_rptr <- tibble(
  Tank_Type = c("Short", "Tall"),
  r = c(Old_high_dur2$R$Fish_ID,Tall_high_dur2$R$Fish_ID),
  ci.lb = c(Old_high_dur2$CI_emp$`2.5%`,Tall_high_dur2$CI_emp$`2.5%`),
  ci.ub = c(Old_high_dur2$CI_emp$`97.5%`,Tall_high_dur2$CI_emp$`97.5%`))
  
high_dur_rptr

plot_high_dur_rptr <- ggplot(high_dur_rptr, aes(x=Tank_Type, y=r, colour=Tank_Type)) +
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = Tank_Type, y = r), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Tank Type", y = "r") +
  labs(subtitle = "C. Time spent in high zone")+
  coord_flip()+
   theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  ylim(0, 1)
plot_high_dur_rptr
```

Freezing duration
```{r, echo=FALSE}
freezing_dur_rptr <- tibble(
  Tank_Type = c("Short", "Tall"),
  r = c(Old_freezing_dur3$R$Fish_ID,Tall_freezing_dur3$R$Fish_ID),
  ci.lb = c(Old_freezing_dur3$CI_emp$`2.5%`,Tall_freezing_dur3$CI_emp$`2.5%`),
  ci.ub = c(Old_freezing_dur3$CI_emp$`97.5%`,Tall_freezing_dur3$CI_emp$`97.5%`))
  
freezing_dur_rptr

plot_freezing_dur_rptr <- ggplot(freezing_dur_rptr, aes(x=Tank_Type, y=r, colour=Tank_Type)) +
  geom_errorbar(aes(ymin=ci.lb, ymax=ci.ub), width = 0, position = position_dodge(0.3)) +
  geom_point(aes(x = Tank_Type, y = r), position = position_dodge(0.3))+
  geom_hline(yintercept = 0, lty = "dotted") +
  labs(x = "Tank Type", y = "r") +
  labs(subtitle = "B. Time spent freezing")+
  coord_flip()+
   theme(axis.title.y=element_blank(),
        axis.text.y=element_blank(),
        axis.ticks.y=element_blank())+
  ylim(0, 1)
plot_freezing_dur_rptr
```


More plots
```{r, echo=FALSE}
Violin_Dist <- ggplot2.violinplot(data=Anxiety_Joined, xName='Tank',yName='tot_dist', 
    groupName='Tank',
    groupColors=c('#999999','#E69F00'), showLegend=TRUE,
    backgroundColor="white", xtitle="Tank", ytitle="Total Distance", 
    mainTitle="Total Distance: Tall vs Short",
    addDot=FALSE, dotSize=0.3)+
  facet_grid(~Sex)
Violin_Dist

Violin_Low <- ggplot2.violinplot(data=Anxiety_Joined, xName='Tank',yName='low_dur', 
    groupName='Tank',
    groupColors=c('#999999','#E69F00'), showLegend=TRUE,
    backgroundColor="white", xtitle="Tank", ytitle="Low Duration", 
    mainTitle="Time spent in low zone: Tall vs Short",
    addDot=FALSE, dotSize=0.3)+
  facet_grid(~Sex)
Violin_Low

Violin_Mid <- ggplot2.violinplot(data=Anxiety_Joined, xName='Tank',yName='mid_dur', 
    groupName='Tank',
    groupColors=c('#999999','#E69F00'), showLegend=TRUE,
    backgroundColor="white", xtitle="Tank", ytitle="Mid Duration", 
    mainTitle="Time spent in mid zone: Tall vs Short",
    addDot=FALSE, dotSize=0.3)+
  facet_grid(~Sex)
Violin_Mid

Violin_High <- ggplot2.violinplot(data=Anxiety_Joined, xName='Tank',yName='high_dur', 
    groupName='Tank',
    groupColors=c('#999999','#E69F00'), showLegend=TRUE,
    backgroundColor="white", xtitle="Tank", ytitle="High Duration", 
    mainTitle="Time spent in high zone: Tall vs Short",
    addDot=FALSE, dotSize=0.3)+
  facet_grid(~Sex)
Violin_High

Violin_Freezing <- ggplot2.violinplot(data=Anxiety_Joined, xName='Tank',yName='freezing_dur', 
    groupName='Tank',
    groupColors=c('#999999','#E69F00'), showLegend=TRUE,
    backgroundColor="white", xtitle="Tank", ytitle="Freezing Duration", 
    mainTitle="Time spent in freezing: Tall vs Short",
    addDot=FALSE, dotSize=0.3)+
  facet_grid(~Sex)
Violin_Freezing
```







